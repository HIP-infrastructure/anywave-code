stages:
    - build
    - test
    
variables:
   registry: gitlab.thevirtualbrain.org:5000
   CONTAINER_TEST_IMAGE: gitlab.thevirtualbrain.org:5000/anywave/anywave:$CI_BUILD_REF_NAME
   CONTAINER_UBUNTU_IMAGE: gitlab.thevirtualbrain.org:5000/anywave/anywave:ubuntu
   CONTAINER_RELEASE_IMAGE:  gitlab.thevirtualbrain.org:5000/anywave/anywave:latest
   USER: anywave

before_script:
   - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $registry
   
build:
   stage: build
   script:
     - docker build -t $CONTAINER_UBUNTU_IMAGE -f Docker/Dockerfile-aw-ubuntu Docker
     - docker push  $CONTAINER_UBUNTU_IMAGE
     - docker build -t $CONTAINER_TEST_IMAGE -f Docker/Dockerfile-aw .
     - docker push $CONTAINER_TEST_IMAGE

test:
   stage: test
   script:
     - docker run -it \
            --user=$USER \
            --env="DISPLAY" \
            --workdir="/home/$USER" \
            --volume="/home/$USER:/home/$USER" \
            --volume="/etc/group:/etc/group:ro" \
            --volume="/etc/passwd:/etc/passwd:ro" \
            --volume="/etc/shadow:/etc/shadow:ro" \
            --volume="/etc/sudoers.d:/etc/sudoers.d:ro" \
            --volume="/tmp/.X11-unix:/tmp/.X11-unix:rw" \
            osrf/ros:indigo-desktop-full \
            anywave
